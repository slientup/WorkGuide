
- [产生背景](#产生背景)

- [Apollo](#Apollo)
    - [架构](#架构)
    - [客户端案例](#客户端使用案例)
    - [源码分析](#源码分析)
- [spring-cloud-config](#spring-cloud-config)
    - [架构](#架构)
    
### 产生背景
**困境**：在写单机应用的时候，我们通常将跟配置有关的常量放入到配置文件中，它会带来以下问题，我要做任何一个参数的修改都要重启服务，甚至重新打包，也许单机应用你可以忍受，但是在分布式场景，几十台vm甚至几百台的时候，你就无法忍受每台设备去更改，还要重启服务。为了解决这个问题，你可能尝试将配置参数配置在数据库中，每次程序调用时都去拉取一遍，这对第三方可靠性运行就要求很大了，而且这些都是没必要存在的流量（这个思路还不够好）    
**分布式配置中心目标**:将配置文件从应用程序中脱离出来，**统一管理，统一下发，动态刷新，不需要重启服务。**   
**相关产品**: 百度`disconf`  携程`Apollo`   `spring-cloud-config`


### Apollo
#### 架构
##### 基础版
 ![基本架构](https://github.com/ctripcorp/apollo/raw/master/doc/images/basic-architecture.png)
1. 用户在配置中心对配置修改并发布  
2. 配置中心通知Apollo客户端有配置更新  
3. Apollo客户端从配置中心拉取最新的配置、更新本地配置并通知应用   
##### 增强版
![增强版](https://github.com/ctripcorp/apollo/raw/master/doc/images/client-architecture.png)
**增加定时更新功能**  
上图简要描述了Apollo客户端的实现原理：  
1. 客户端和服务端保持了一个长连接，从而能第一时间获得配置更新的推送。（通过Http Long Polling实现）
2. 客户端还会定时从Apollo配置中心服务端拉取应用的最新配置。
   - 这是一个`fallback`机制，为了**防止推送机制失效导致配置不更新**
   - 客户端定时拉取会上报本地版本，所以一般情况下，对于定时拉取的操作，服务端都会返回304 - Not Modified
   - 定时频率默认为每5分钟拉取一次，客户端也可以通过在运行时指定System Property: apollo.refreshInterval来覆盖，单位为分钟。
3. 客户端从Apollo配置中心服务端获取到应用的最新配置后，会保存在内存中
4. 客户端会把从服务端获取到的配置在本地文件系统缓存一份
   - 在遇到服务不可用，或网络不通的时候，**依然能从本地恢复配置**
5. 应用程序可以从Apollo客户端获取最新的配置、订阅配置更新通知



#### 客户端使用案例
#### 源码分析







